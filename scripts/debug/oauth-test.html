<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBay OAuth Test - Colecciones App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .step {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #0072CE;
            background: #f8f9fa;
        }
        .button {
            display: inline-block;
            background: #0072CE;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 5px;
            margin: 10px 0;
            border: none;
            cursor: pointer;
        }
        .button:hover {
            background: #005a9e;
        }
        .code {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        #result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîë eBay OAuth Test</h1>
        <p>Test completo del flujo OAuth con tu aplicaci√≥n de Colecciones</p>
        
        <div class="step">
            <h3>üìã Informaci√≥n de tu App:</h3>
            <p><strong>App ID:</strong> <code>SergioFr-Collecti-PRD-36e4180bf-6f605e3e</code></p>
            <p><strong>Redirect URL:</strong> <code>https://collections-project-2025.vercel.app/api/ebay-oauth</code></p>
        </div>

        <div class="step">
            <h3>1Ô∏è‚É£ Iniciar OAuth Flow</h3>
            <p>Haz clic aqu√≠ para iniciar el flujo OAuth oficial de eBay:</p>
            <button class="button" onclick="startOAuth()">üöÄ Iniciar OAuth con eBay</button>
        </div>

        <div class="step">
            <h3>2Ô∏è‚É£ Resultado:</h3>
            <div id="result">
                <p>Haz clic en "Iniciar OAuth" para comenzar el proceso...</p>
            </div>
        </div>

        <div class="step">
            <h3>üìù Instrucciones:</h3>
            <ol>
                <li>Haz clic en "Iniciar OAuth"</li>
                <li>eBay te pedir√° autorizar tu aplicaci√≥n</li>
                <li>Despu√©s de autorizar, volver√°s aqu√≠ con un c√≥digo</li>
                <li>El sistema intercambiar√° el c√≥digo por un token v√°lido</li>
            </ol>
        </div>

        <div class="step">
            <h3>üîß Debug Info:</h3>
            <p><strong>Environment:</strong> Production</p>
            <p><strong>Scopes:</strong> https://api.ebay.com/oauth/api_scope/sell.marketing.readonly https://api.ebay.com/oauth/api_scope/sell.inventory.readonly</p>
            <p><strong>Estado:</strong> <span id="status">Esperando...</span></p>
        </div>
    </div>

    <script>
        function startOAuth() {
            const appId = 'SergioFr-Collecti-PRD-36e4180bf-6f605e3e';
            const redirectUri = 'https://collections-project-2025.vercel.app/api/ebay-oauth';
            const scope = 'https://api.ebay.com/oauth/api_scope/sell.marketing.readonly https://api.ebay.com/oauth/api_scope/sell.inventory.readonly';
            const state = 'test_oauth_' + Date.now();
            
            // Guardar el state para verificar despu√©s
            localStorage.setItem('oauth_state', state);
            
            const oauthUrl = `https://auth.ebay.com/oauth2/authorize?` +
                `client_id=${encodeURIComponent(appId)}&` +
                `response_type=code&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `state=${encodeURIComponent(state)}`;
            
            document.getElementById('status').textContent = 'Redirigiendo a eBay...';
            document.getElementById('result').innerHTML = `
                <div class="code">
                    <strong>OAuth URL generada:</strong><br>
                    ${oauthUrl}
                </div>
                <p>Redirigiendo a eBay para autorizaci√≥n...</p>
            `;
            
            // Abrir en la misma ventana
            setTimeout(() => {
                window.location.href = oauthUrl;
            }, 2000);
        }

        // Escuchar mensajes del redirect
        window.addEventListener('message', function(event) {
            if (event.origin !== 'https://collections-project-2025.vercel.app') {
                return;
            }
            
            const data = event.data;
            const resultDiv = document.getElementById('result');
            const status = document.getElementById('status');
            
            if (data.success) {
                status.textContent = 'OAuth exitoso!';
                resultDiv.innerHTML = `
                    <div class="success">
                        <h4>‚úÖ OAuth Exitoso!</h4>
                        <p><strong>C√≥digo recibido:</strong> ${data.code}</p>
                        <p><strong>State:</strong> ${data.state}</p>
                        <p>Ahora puedes usar este c√≥digo para obtener el access token.</p>
                    </div>
                `;
            } else {
                status.textContent = 'Error en OAuth';
                resultDiv.innerHTML = `
                    <div class="error">
                        <h4>‚ùå Error en OAuth</h4>
                        <p><strong>Error:</strong> ${data.error}</p>
                        <p><strong>Descripci√≥n:</strong> ${data.error_description || 'No disponible'}</p>
                    </div>
                `;
            }
        });

        // Verificar si venimos de un redirect
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        const error = urlParams.get('error');
        const state = urlParams.get('state');
        
        if (code) {
            document.getElementById('status').textContent = 'C√≥digo recibido!';
            document.getElementById('result').innerHTML = `
                <div class="success">
                    <h4>‚úÖ C√≥digo OAuth recibido!</h4>
                    <p><strong>C√≥digo:</strong> <code>${code}</code></p>
                    <p><strong>State:</strong> <code>${state}</code></p>
                    <p>Ahora necesitas intercambiar este c√≥digo por un access token usando tu Client Secret.</p>
                </div>
            `;
        } else if (error) {
            document.getElementById('status').textContent = 'Error recibido';
            document.getElementById('result').innerHTML = `
                <div class="error">
                    <h4>‚ùå Error OAuth:</h4>
                    <p><strong>Error:</strong> ${error}</p>
                    <p><strong>Descripci√≥n:</strong> ${urlParams.get('error_description') || 'No disponible'}</p>
                </div>
            `;
        }
    </script>
</body>
</html>